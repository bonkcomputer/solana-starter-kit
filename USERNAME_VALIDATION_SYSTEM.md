# Username Validation & Uniqueness System

## 🛡️ Overview

The application implements a comprehensive username validation and uniqueness system with graceful error handling across all layers: client-side, server-side, and database level.

## 🔧 System Architecture

### 1. Centralized Validation (`src/utils/username-validation.ts`)

**Core Validation Rules:**
- **Length**: 3-20 characters
- **Format**: Lowercase letters and numbers only (`/^[a-z0-9]+$/`)
- **Reserved Names**: Admin, system, root, etc. (15 reserved usernames)
- **Uniqueness**: Checked against database

**Key Functions:**
```typescript
validateUsername(username: string): UsernameValidationResult
sanitizeUsername(input: string): string
generateUsernameSuggestions(baseUsername: string): string[]
isAutoGeneratedUsername(username: string): boolean
```

### 2. Client-Side Validation

**Real-time Input Sanitization:**
- `CreateProfile` component: Auto-sanitizes input as user types
- `UsernameEditor` component: Validates before submission
- Immediate feedback for invalid characters

**Error Handling:**
- Clear, user-friendly error messages
- Real-time validation feedback
- Suggestions for auto-generated usernames

### 3. Server-Side Validation

**API Endpoints with Validation:**
- `/api/profiles/create` - Profile creation with username validation
- `/api/profiles/username` - Username updates with validation

**Validation Flow:**
1. **Format Validation**: Check length, characters, reserved names
2. **Uniqueness Check**: Query database for existing username
3. **Rate Limiting**: Prevent frequent username changes (1 week cooldown)
4. **Error Responses**: Structured error messages with appropriate HTTP status codes

### 4. Database Level Protection

**Schema Constraints:**
```prisma
model User {
  username String @unique  // Database-level uniqueness constraint
  lastUsernameChange DateTime?  // Rate limiting
}
```

**Uniqueness Enforcement:**
- Database unique constraint prevents duplicates
- Graceful handling of constraint violations
- Atomic operations for username updates

## 🔄 Username Generation (Restored Users)

**Priority Order:**
1. **Email-based**: Extract username from email address
2. **Wallet-based**: `user_` + first 8 characters of wallet address
3. **ID-based**: `user_` + last 8 characters of Privy ID

**Uniqueness Handling:**
- Check generated username against database
- Append incrementing numbers if duplicate (`username_1`, `username_2`)
- Ensure all generated usernames follow validation rules

## 🚨 Error Handling & User Experience

### Validation Errors

**Client-Side:**
```typescript
// Real-time validation with immediate feedback
const validation = validateUsernameRealTime(username)
if (!validation.isValid) {
  setError(validation.error)
  // Show error message to user
}
```

**Server-Side:**
```typescript
// Comprehensive error responses
if (!usernameValidation.isValid) {
  return NextResponse.json(
    { error: usernameValidation.error },
    { status: 400 }
  )
}
```

### Uniqueness Conflicts

**HTTP Status Codes:**
- `400` - Invalid format/validation error
- `409` - Username already taken
- `429` - Rate limit exceeded (too frequent changes)
- `500` - Server error

**Error Messages:**
- "Username is already taken"
- "Username must contain only lowercase letters and numbers"
- "Username can only be changed once per week"
- "This username is reserved and cannot be used"

### Rate Limiting

**Cooldown System:**
- Users can change username once per week
- `lastUsernameChange` timestamp tracked
- Clear messaging about when next change is allowed
- Days remaining calculation for user feedback

## 🧪 Testing & Validation

**Test Coverage:**
- Valid username formats
- Invalid characters and lengths
- Reserved username detection
- Database uniqueness checks
- Rate limiting functionality

**Test Script:** `pnpm run test:username-validation`

## 🔒 Security Considerations

**Input Sanitization:**
- All input sanitized before processing
- SQL injection prevention through Prisma ORM
- XSS prevention through input validation

**Rate Limiting:**
- Prevents username squatting
- Reduces server load from frequent changes
- Maintains data integrity

**Reserved Names:**
- Prevents impersonation of system accounts
- Protects administrative usernames
- Maintains platform security

## 📊 Monitoring & Maintenance

**Database Health Checks:**
- Username uniqueness verification
- Validation rule compliance
- Auto-generated username detection

**Scripts Available:**
- `db:status` - Check database health including username validation
- `test:username-validation` - Run comprehensive validation tests
- `db:update-restored-bios` - Update bio messages for restored users

## 🎯 Best Practices

**For Developers:**
1. Always use centralized validation utilities
2. Implement both client and server-side validation
3. Provide clear, actionable error messages
4. Test edge cases thoroughly

**For Users:**
1. Choose memorable, unique usernames
2. Avoid special characters (they'll be removed)
3. Plan username changes (limited to once per week)
4. Restored users can easily change auto-generated usernames

## 🔄 Future Enhancements

**Potential Improvements:**
- Username suggestions for taken usernames
- Bulk username validation for imports
- Advanced rate limiting based on user behavior
- Username history tracking
- Custom validation rules per user type

---

**The system ensures robust username validation with graceful error handling at every level, providing a smooth user experience while maintaining data integrity and security.** 🚀
